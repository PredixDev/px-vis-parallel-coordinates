<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-colors-design/colors.html" />
<link rel="import" href="../px-vis/px-vis-behavior-d3.html" />
<link rel="import" href="../px-vis/px-vis-svg-canvas.html"/>
<link rel="import" href="../px-vis/px-vis-line.html"/>
<link rel="import" href="../px-vis/px-vis-multi-axis.html"/>
<link rel="import" href="../px-vis/px-vis-multi-scale.html"/>
<link rel="import" href="../px-vis/px-vis-gridlines.html"/>


<!--
Element providing solution to no problem in particular. As a simple example, increments a counter when clicked.

##### Usage

    <px-vis-parallel-coordinates counter-value="1">Hi</px-vis-parallel-coordinates>

@element px-vis-parallel-coordinates
@blurb Element providing solution to no problem in particular.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-vis-parallel-coordinates">
  <link rel="import" type="css" href="css/px-vis-parallel-coordinates.css"/>
  <template>
    <px-vis-multi-scale
      x-axis-type="ordinal"
      y-axis-type="linear"
      parallel-coordinates
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      dimensions="[[dimensions]]"
      chart-data="[[chartData]]"
      complete-series-config="[[completeSeriesConfig]]"
      chart-extents="[[chartExtents]]"
      x="{{x}}"
      y="{{y}}"
      current-domain-x="{{currentDomainX}}"
      current-domain-y="{{currentDomainY}}">
    </px-vis-multi-scale>
    <px-vis-svg-canvas
      canvas-context="{{canvasContext}}"
      svg="{{svg}}"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]">
    </px-vis-svg-canvas>
    <px-vis-line
      id="line"
      render-to-canvas
      gradient-line
      canvas-context="[[canvasContext]]"
      svg="[[svg]]"
      parallel-coordinates
      multi-path
      series-id="[[seriesKey]]"
      chart-data="[[chartData]]"
      complete-series-config="[[completeSeriesConfig]]"
      x="[[x]]"
      y="[[y]]"
      current-domain-x="[[currentDomainX]]"
      current-domain-y="[[currentDomainY]]"
      muted-series="[[mutedSeries]]">
    </px-vis-line>
    <px-vis-multi-axis
      svg="[[svg]]"
      width="[[width]]"
      margin="[[margin]]"
      title-location='[[titleLocation]]'
      x="[[x]]"
      y="[[y]]"
      current-domain-x="[[currentDomainX]]"
      current-domain-y="[[currentDomainY]]"
      complete-series-config="{{completeSeriesConfig}}"
      series-key="[[seriesKey]]"
      chart-data="[[chartData]]"
      dimensions="[[dimensions]]"
      muted-series="{{mutedSeries}}"
      redraw-series="true"
      redraw-elems="[[_lineRedrawFun()]]"
      stroke-width="2"
      match-ticks
      outer-tick-size="6">
    </px-vis-multi-axis>
    <px-vis-gridlines
      svg="[[svg]]"
      axis="[[_returnFirstY(y,dimensions)]]"
      margin="[[margin]]"
      length="[[width]]"
      orientation="left"
      current-domain="[[currentDomainY]]">
    </px-vis-gridlines>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-vis-parallel-coordinates',

    behaviors: [
      PxVisBehavior.sizing,
      PxVisBehaviorD3.svg,
      PxVisBehaviorD3.canvas,
      PxVisBehaviorD3.axes,
      PxVisBehaviorD3.axis,
      PxVisBehavior.dataset,
      PxVisBehavior.dimensions,
      PxVisBehavior.commonMethods,
      PxVisBehavior.chartExtents,
      PxVisBehavior.completeSeriesConfig,
      PxVisBehaviorD3.axisConfig,
      PxVisBehavior.mutedSeries,
      PxVisBehaviorD3.dynamicRedraw,
      commonColors
    ],

    /**
     * Properties block, expose attribute values to the DOM via 'notify'
     *
     * @property properties
     * @type Object
     */
    properties: {

      axes: {
        type: Array,
        notify: true,
        value: function(){ return []; }
      },

      skipKeys: {
        type: Object,
        notify: true,
        value: function() { return {}; }
      },

      seriesKey: {
        type: String,
        notify: true
      },

      dimensions: {
        type: Array,
        notify: true,
        computed: '_computeDimensions(chartData.*, axes, skipKeys.*)'
      }
    },

    observers: [
      '_generateChartExtents(dimensions,chartData)',
      '_generateSeriesConfig(dimensions,chartData)',
      '_calcRenderTarget(chartData)'
    ],

    ready:function(){
      console.time('draw');
      this.set('margin', { "top": 10, "right": 15, "left": 30, "bottom": 50});
      this.set('titleLocation',{
        "x":"0",
        "y":this.height - this.margin.bottom,
        "r":"-20",
        "anchor":"end"
      });
    },

    _calcRenderTarget: function(){
      this.set('renderToCanvas', this.chartData.length < 8000 );
    },

    _computeDimensions: function(cD, axes, sK){
      if(this._doesObjHaveValues(this.chartData)){
        if(axes.length > 0) {
          return axes;
        }
        return Object.keys(this.chartData[0]).filter(function(d) {
          return typeof(this.skipKeys[d]) === 'undefined'
        }.bind(this));
      }
    },

    _generateSeriesConfig: function(dimensions){
      // TODO make work with multiple series
      var config = {};
      config[this.seriesKey] = {
        "color": this._getColor(18),
        "name": 'All',
        "x": dimensions,
        "y": dimensions
      }

      this.set('completeSeriesConfig',config);
    },

    // * These are in behavior chart. Should make it so we can import them from there */
    /**
     * Helper function to return the correct color for a particular index.
     **/
    _getColor: function(i){
      var l = this.seriesColorOrder.length,
          index = this._calcIndex(i,l);
      return this.dataVisColors[this.seriesColorOrder[ index ]];
    },
    /**
     * Helper function to calculate the index. When we run out of indcies, it loops back over valid indicies.
     **/
    _calcIndex: function(i,l){
      return i < l ? i : this._calcIndex(i - l,l);
    },

    _generateChartExtents: function(dimensions){
      var ext = {
        "x": dimensions,
        "y": {}
      };

      for(var i = 0; i < dimensions.length; i++){
        // TODO Make dynamic option
        // ext.y[dimensions[i]] = [Infinity,-Infinity];
        ext.y[dimensions[i]] = d3.extent(this.chartData, function(d) {
          return Number(d[dimensions[i]]);
        });
      }
      this.set('chartExtents',ext);
    },

    _lineRedrawFun: function(){
      return [this.$.line]
    },

    _returnFirstY: function(y,dimensions){
      return y[dimensions[0]]
    },

    _returnKeys: function(obj){
      return Object.keys(obj);
    }
  });
</script>
